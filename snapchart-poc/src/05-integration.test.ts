#!/usr/bin/env bun

import chalk from 'chalk';
import { writeFile } from 'fs/promises';
import { spawn } from 'child_process';

interface TestSuite {
  name: string;
  command: string;
}

const suites: TestSuite[] = [
  { name: 'í™˜ê²½ ê²€ì¦', command: 'bun src/00-setup-check.ts' },
  { name: 'AI ê¸°ë³¸', command: 'bun src/01-ai-basic.test.ts' },
  { name: 'ë‹¤ì´ì–´ê·¸ë¨ ìƒì„±', command: 'bun src/02-ai-diagrams.test.ts' },
  { name: 'Mermaid ë Œë”ë§', command: 'bun src/03-mermaid-render.test.ts' },
  { name: 'ë¹„ìš© ë¶„ì„', command: 'bun src/04-cost-analysis.ts' }
];

interface TestResult {
  suite: string;
  status: 'pass' | 'fail' | 'skip';
  duration: number;
}

const results: TestResult[] = [];

async function runSuite(suite: TestSuite): Promise<boolean> {
  console.log(chalk.bold.blue(`\nâ–¶ ${suite.name} ì‹¤í–‰ ì¤‘...\n`));
  const startTime = Date.now();

  return new Promise((resolve) => {
    try {
      const args = suite.command.split(' ');
      const command = args[0];
      const commandArgs = args.slice(1);

      const proc = spawn(command, commandArgs, {
        stdio: 'inherit'
      });

      proc.on('close', (exitCode) => {
        const duration = Date.now() - startTime;

        if (exitCode === 0) {
          results.push({
            suite: suite.name,
            status: 'pass',
            duration
          });
          resolve(true);
        } else {
          results.push({
            suite: suite.name,
            status: 'fail',
            duration
          });
          resolve(false);
        }
      });

      proc.on('error', (error) => {
        results.push({
          suite: suite.name,
          status: 'fail',
          duration: Date.now() - startTime
        });
        resolve(false);
      });
    } catch (error) {
      results.push({
        suite: suite.name,
        status: 'fail',
        duration: Date.now() - startTime
      });
      resolve(false);
    }
  });
}

async function generateReport() {
  const passed = results.filter(r => r.status === 'pass').length;
  const total = results.length;
  const successRate = (passed / total * 100).toFixed(1);
  const totalTime = results.reduce((sum, r) => sum + r.duration, 0);

  const report = `# SnapChart PoC í…ŒìŠ¤íŠ¸ ë¦¬í¬íŠ¸

**ì‹¤í–‰ ì¼ì‹œ**: ${new Date().toLocaleString('ko-KR')}
**ì´ ì†Œìš” ì‹œê°„**: ${(totalTime / 1000).toFixed(1)}ì´ˆ
**ì„±ê³µë¥ **: ${successRate}% (${passed}/${total})

---

## ğŸ“Š í…ŒìŠ¤íŠ¸ ê²°ê³¼

| í…ŒìŠ¤íŠ¸ | ìƒíƒœ | ì†Œìš” ì‹œê°„ |
|--------|------|-----------|
${results.map(r => {
  const icon = r.status === 'pass' ? 'âœ…' : 'âŒ';
  return `| ${r.suite} | ${icon} ${r.status} | ${(r.duration / 1000).toFixed(1)}s |`;
}).join('\n')}

---

## ğŸ¯ ìµœì¢… íŒë‹¨

${passed === total
  ? `### âœ… í…ŒìŠ¤íŠ¸ í†µê³¼!

ëª¨ë“  í…ŒìŠ¤íŠ¸ë¥¼ ì„±ê³µì ìœ¼ë¡œ í†µê³¼í–ˆìŠµë‹ˆë‹¤. SnapChart í”„ë¡œì íŠ¸ë¥¼ ì‹œì‘í•  ì¤€ë¹„ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.

**ê²€ì¦ëœ ê¸°ëŠ¥:**
- âœ… Claude API í’ˆì§ˆ (90%+ ì •í™•ë„)
- âœ… ë‹¤ì–‘í•œ ë‹¤ì´ì–´ê·¸ë¨ íƒ€ì… ì§€ì›
- âœ… Mermaid ë Œë”ë§ ì•ˆì •ì„±
- âœ… API ë¹„ìš© ì ì • ($0.0165/ìš”ì²­)

**ì˜ˆìƒ ë¹„ìš©:**
- ì¶œì‹œ ì´ˆê¸°: $150/ì›”
- 6ê°œì›” í›„: $2,970/ì›”
- ì˜ˆìƒ ìˆ˜ìµ: $3,500/ì›”
- ìˆœì´ìµ: $530/ì›” (15% ë§ˆì§„)

**ë‹¤ìŒ ë‹¨ê³„:**
1. ìƒí‘œê¶Œ ìµœì¢… í™•ì¸ (snapchart, SnapChart)
2. ë„ë©”ì¸ êµ¬ë§¤ (snapchart.io, snapchart.pro)
3. í”„ë¡œì íŠ¸ ì´ˆê¸°í™” (Vite + React)
4. MVP ê°œë°œ ì‹œì‘ (4ì£¼ ëª©í‘œ)`
  : `### âš ï¸ ì¼ë¶€ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨

${total - passed}ê°œì˜ í…ŒìŠ¤íŠ¸ê°€ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì‹¤íŒ¨ ì›ì¸ì„ ë¶„ì„í•˜ê³  ì¬ì‹œë„í•˜ì„¸ìš”.

**ì‹¤íŒ¨í•œ í…ŒìŠ¤íŠ¸:**
${results.filter(r => r.status === 'fail').map(r => `- ${r.suite}`).join('\n')}

**í•´ê²° ë°©ë²•:**
1. API í‚¤ í™•ì¸ (.env íŒŒì¼)
2. ë„¤íŠ¸ì›Œí¬ ì—°ê²° í™•ì¸
3. ì˜ì¡´ì„± ì¬ì„¤ì¹˜ (bun install)
4. ê° í…ŒìŠ¤íŠ¸ë¥¼ ê°œë³„ ì‹¤í–‰í•˜ì—¬ ìƒì„¸ ì—ëŸ¬ í™•ì¸
5. Claude API í¬ë ˆë”§ ì”ì•¡ í™•ì¸`}

---

## ğŸ“ ìƒì„¸ ë¡œê·¸

ìƒì„±ëœ ë‹¤ì´ì–´ê·¸ë¨ì€ \`./results/diagrams/\` í´ë”ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
ë¹„ìš© ë¶„ì„ ê²°ê³¼ëŠ” \`./results/cost-estimate.json\`ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.

---

**Generated by SnapChart PoC Runner**
`;

  await writeFile('./results/test-report.md', report);
  console.log(chalk.green('\nâœ… ë¦¬í¬íŠ¸ ìƒì„± ì™„ë£Œ: results/test-report.md\n'));
}

async function runIntegrationTest() {
  console.log(chalk.bold.blue('\nğŸš€ SnapChart PoC í†µí•© í…ŒìŠ¤íŠ¸ ì‹œì‘\n'));
  console.log(chalk.gray('ëª¨ë“  í…ŒìŠ¤íŠ¸ë¥¼ ìˆœì°¨ì ìœ¼ë¡œ ì‹¤í–‰í•©ë‹ˆë‹¤...\n'));

  let allPassed = true;

  for (const suite of suites) {
    const passed = await runSuite(suite);
    if (!passed) {
      allPassed = false;
      console.log(chalk.red(`\nâŒ ${suite.name} ì‹¤íŒ¨ - ê³„ì† ì§„í–‰í•©ë‹ˆë‹¤...\n`));
    }
  }

  // ë¦¬í¬íŠ¸ ìƒì„±
  await generateReport();

  // ìµœì¢… ìš”ì•½
  console.log('\n' + '='.repeat(50));
  console.log(chalk.bold.blue('\nğŸ“Š SnapChart PoC ìµœì¢… ê²°ê³¼\n'));

  const passed = results.filter(r => r.status === 'pass').length;
  const total = results.length;
  const successRate = (passed / total * 100).toFixed(1);

  console.log(`   ì´ í…ŒìŠ¤íŠ¸: ${total}`);
  console.log(chalk.green(`   í†µê³¼: ${passed}`));
  console.log(chalk.red(`   ì‹¤íŒ¨: ${total - passed}`));
  console.log(chalk.bold(`   ì„±ê³µë¥ : ${successRate}%\n`));

  if (allPassed) {
    console.log(chalk.green.bold('ğŸ‰ ì¶•í•˜í•©ë‹ˆë‹¤! ëª¨ë“  PoC í…ŒìŠ¤íŠ¸ë¥¼ í†µê³¼í–ˆìŠµë‹ˆë‹¤!\n'));
    console.log(chalk.cyan('ğŸ“‹ ë‹¤ìŒ ë‹¨ê³„:'));
    console.log('   1. results/test-report.md í™•ì¸');
    console.log('   2. results/diagrams/ í´ë”ì˜ ìƒì„±ëœ ë‹¤ì´ì–´ê·¸ë¨ í™•ì¸');
    console.log('   3. ìƒí‘œê¶Œ ì¡°ì‚¬ (KIPRIS, USPTO)');
    console.log('   4. ë„ë©”ì¸ êµ¬ë§¤ (snapchart.io)');
    console.log('   5. í”„ë¡œì íŠ¸ ê°œë°œ ì‹œì‘\n');
    process.exit(0);
  } else {
    console.log(chalk.yellow.bold('âš ï¸ ì¼ë¶€ í…ŒìŠ¤íŠ¸ê°€ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.\n'));
    console.log(chalk.cyan('ğŸ“‹ í•´ê²° ë°©ë²•:'));
    console.log('   1. ì‹¤íŒ¨í•œ í…ŒìŠ¤íŠ¸ë¥¼ ê°œë³„ ì‹¤í–‰ (bun run test:*)');
    console.log('   2. ì—ëŸ¬ ë©”ì‹œì§€ í™•ì¸');
    console.log('   3. API í‚¤ ë° í™˜ê²½ ë³€ìˆ˜ ì¬í™•ì¸');
    console.log('   4. í•„ìš”ì‹œ í”„ë¡¬í”„íŠ¸ ì¡°ì •\n');
    process.exit(1);
  }
}

runIntegrationTest();
